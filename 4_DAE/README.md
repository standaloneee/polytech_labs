# Denoising Autoencoder (DAE) для медицинских изображений

Проект посвящен разработке модели глубокого обучения для подавления шумов в медицинских изображениях клеток крови.

## Описание задачи

Создание Denoising Autoencoder (DAE) для удаления различных типов шума из изображений клеток крови:
- **Гауссовский шум** (стохастический) - моделирует шум от датчиков камеры
- **Импульсный шум** (Salt & Pepper) - моделирует ошибки передачи данных
- **Смешанный шум** - комбинация обоих типов

## Датасет

- **Источник:** [BCCD Dataset](https://github.com/Shenggan/BCCD_Dataset)
- **Количество изображений:** 364
- **Разрешение:** 640×480 пикселей
- **Формат:** RGB JPEG
- **Разделение:** Train (80%) / Val (20%)

## Архитектура модели

### Encoder (кодировщик)
Сжимает изображение в latent representation:
- 3 сверточных блока (Conv2d + BatchNorm + ReLU + MaxPool)
- Уменьшение пространственного разрешения: 640×480 → 80×60
- Увеличение каналов: 3 → 32 → 64 → 128

### Decoder (декодировщик)
Восстанавливает изображение из latent space:
- 3 транспонированных сверточных блока (ConvTranspose2d + BatchNorm + ReLU)
- Увеличение разрешения: 80×60 → 640×480
- Уменьшение каналов: 128 → 64 → 32 → 3

**Всего параметров:** ~378,000

## Эксперименты

Проведено 6 экспериментов с различными комбинациями:

| № | Тип шума | Функция потерь | SSIM | PSNR (dB) | MSE | Рейтинг |
|---|----------|---------------|------|-----------|-----|---------|
| 1 | Гауссовский (средний) | MSE | 0.9300 | 37.08 | 0.000197 | 5-е место |
| 2 | Гауссовский (средний) | MAE | 0.9325 | 37.05 | 0.000199 | 4-е место |
| 3 | Импульсный (средний) | MSE | **0.9502** | **38.74** | **0.000134** | **1-е место** |
| 4 | Импульсный (средний) | MAE | 0.8643 | 30.81 | 0.000837 | 6-е место |
| 5 | Смешанный (средний) | MSE | 0.9424 | 38.55 | 0.000141 | 2-е место |
| 6 | Смешанный (средний) | MAE | 0.9421 | 37.88 | 0.000164 | 3-е место |

**Все 6 моделей обучены и оценены (100%)**

## Метрики качества

- **SSIM** (Structural Similarity Index) - структурная схожесть изображений [0, 1]
- **PSNR** (Peak Signal-to-Noise Ratio) - отношение сигнал/шум в dB
- **MSE** (Mean Squared Error) - среднеквадратичная ошибка

## Структура проекта

```
4_DAE/
├── data/
│   └── raw/                    # Изображения (НЕ коммитится, скачать вручную)
├── models/                      # Модели (НЕ коммитится, ~4.4MB каждая)
├── notebooks/
│   └── denoising_analysis.ipynb # ✅ Jupyter Notebook с анализом (коммитится)
├── results/
│   ├── metrics/
│   │   ├── *.json              # ✅ Метрики (коммитятся, легкие)
│   │   └── *.png               # ❌ Визуализации (НЕ коммитятся, ~6-8MB каждая)
│   ├── comparison_analysis.md   # ✅ Анализ (коммитится)
│   └── PROJECT_STATUS.md        # ✅ Статус (коммитится)
├── scripts/
│   ├── model.py                 # ✅ Архитектура (коммитится)
│   ├── noise.py                 # ✅ Функции шумов (коммитится)
│   ├── train.py                 # ✅ Обучение (коммитится)
│   ├── evaluate.py              # ✅ Оценка (коммитится)
│   └── run_experiments.py       # ✅ Запуск (коммитится)
├── .gitignore                   # Настройки git
├── requirements.txt             # ✅ Зависимости (коммитится)
└── README.md                    # ✅ Документация (коммитится)
```

### Что коммитится в Git:
- ✅ **Весь код** (scripts/, notebooks/)
- ✅ **JSON результаты** с метриками (~500 байт каждый)
- ✅ **Markdown документация** (анализ, выводы, README)
- ✅ **Конфигурации** (requirements.txt, .gitignore)

### Что НЕ коммитится (в .gitignore):
- ❌ **Датасет** (data/raw/) - нужно скачать вручную (364 изображения, ~50MB)
- ❌ **Модели** (*.pth) - слишком большие (4.4MB × 6 = 26MB)
- ❌ **PNG визуализации** (*.png) - большие файлы (6-8MB × 6 = ~45MB)

**Почему так:** Чтобы репозиторий оставался легким (~1MB), а на втором устройстве ноутбук мог создать визуализации динамически.

## Установка

```bash
# Перейти в директорию проекта
cd 4_DAE

# Установить зависимости
pip install -r requirements.txt

# Скачать датасет BCCD
git clone https://github.com/Shenggan/BCCD_Dataset.git
cp BCCD_Dataset/BCCD/JPEGImages/*.jpg data/raw/

# Или скачайте вручную:
# 1. Скачайте ZIP с https://github.com/Shenggan/BCCD_Dataset
# 2. Распакуйте JPEGImages в data/raw/
```

## Быстрый старт (Jupyter Notebook)

**Для просмотра результатов без обучения:**

```bash
cd notebooks
jupyter notebook denoising_analysis.ipynb
```

Ноутбук автономный и работает "из коробки":
- ✅ Автоматически проверяет наличие датасета
- ✅ Загружает результаты из JSON (коммитятся в git)
- ✅ Если есть PNG визуализации - показывает их
- ✅ Если PNG нет - создаёт динамически из моделей
- ✅ Можно запустить на любом устройстве

## Использование

### Обучение модели

```bash
cd 4_DAE

# Обучить с гауссовским шумом и MSE
python scripts/train.py --noise_type gaussian_medium --loss_fn mse --num_epochs 50

# Обучить с импульсным шумом и MAE
python scripts/train.py --noise_type salt_pepper_medium --loss_fn mae --num_epochs 50
```

Параметры:
- `--noise_type`: тип шума (gaussian_light/medium/heavy, salt_pepper_light/medium/heavy, mixed_light/medium/heavy)
- `--loss_fn`: функция потерь (mse, mae)
- `--num_epochs`: количество эпох (default: 50)
- `--batch_size`: размер батча (default: 8)
- `--lr`: learning rate (default: 0.001)

### Запуск всех экспериментов

```bash
python scripts/run_experiments.py
```

Это запустит 6 экспериментов с разными конфигурациями.

### Оценка модели

```bash
python scripts/evaluate.py --model_path models/gaussian_medium_mse_best.pth
```

Это вычислит SSIM, PSNR, MSE и создаст визуализации результатов.

### TensorBoard

```bash
tensorboard --logdir runs/
```

Затем открыть http://localhost:6006 для просмотра графиков обучения.

## Результаты

### Ключевые выводы (6 моделей)

**Главное открытие:** Эффективность функции потерь критически зависит от типа шума!

**Для Гауссовского шума:**
- MSE и MAE показывают **практически идентичные результаты** (разница < 0.3%)
- SSIM: 0.9300 (MSE) vs 0.9325 (MAE)
- **Вывод:** Выбор функции потерь не критичен

**Для Импульсного шума (Salt & Pepper):**
- MSE **значительно превосходит** MAE!
- SSIM: 0.9502 (MSE) vs 0.8643 (MAE) - разница **+9.9%**
- PSNR: 38.74 (MSE) vs 30.81 (MAE) dB - разница **+25.7%**
- **Вывод:** MSE критически важна для импульсного шума!

**Для Смешанного шума (Mixed):**
- MSE незначительно лучше MAE
- SSIM: 0.9424 (MSE) vs 0.9421 (MAE) - разница +0.03%
- PSNR: 38.55 (MSE) vs 37.88 (MAE) dB - разница +1.8%
- **Вывод:** Обе функции хороши, MSE стабильнее

### Научное объяснение

**Почему MSE лучше для Salt & Pepper?**
- Импульсный шум создаёт **резкие выбросы** (битые пиксели = 0 или 255)
- MSE (квадратичная) **сильно штрафует большие ошибки**: штраф ∝ (255)² = 65,025
- MAE (линейная) одинаково штрафует все ошибки: штраф ∝ 255
- MSE **мотивирует модель исправлять выбросы в первую очередь**

**Почему для Gaussian разницы нет?**
- Гауссовский шум создаёт **плавные изменения** (обычно ±25 пикселей)
- Для малых отклонений: x² ≈ x, поэтому MSE и MAE эквивалентны

### Визуализация

Примеры работы лучшей модели (Salt & Pepper + MSE, SSIM: 0.9502):

*Визуализации доступны в Jupyter Notebook (notebooks/denoising_analysis.ipynb)*

## Выводы

На основе всех 6 завершённых экспериментов:

1. **Архитектура DAE эффективна** для медицинских изображений
   - Простая модель (~378K параметров) достигает SSIM > 0.93
   - Хорошо работает на небольшом датасете (364 изображения)
   - Не требует глубоких сетей или больших ресурсов

2. **Выбор функции потерь критичен** для импульсного шума
   - Нет универсального "лучшего" выбора
   - Необходимо учитывать характер шума
   - MSE превосходит MAE на 10-26% для импульсного шума

3. **MSE более универсальна** чем MAE
   - Не теряет качество ни на одном типе шума
   - Особенно эффективна для импульсных искажений (+9.9% SSIM, +25.7% PSNR)
   - Для гауссовского шума MSE и MAE эквивалентны (< 0.3% разницы)

4. **Практические рекомендации:**
   - Для Gaussian шума: MSE или MAE (любая)
   - Для Salt & Pepper: обязательно MSE
   - Если тип шума неизвестен: Mixed + MSE (универсальный выбор, SSIM 0.9424)

Полный анализ и визуализации доступны в [Jupyter Notebook](notebooks/denoising_analysis.ipynb).

## Документация

Для детального понимания проекта см.:
- **[docs/guide.md](docs/guide.md)** - Технический гайд с объяснением всех деталей:
  - Почему выбраны эти типы шумов и функции потерь
  - Детальное описание каждого скрипта
  - Объяснение архитектуры DAE (почему именно такая)
  - Интерпретация результатов (почему MSE лучше для импульсного шума)
  - Научное объяснение различий между MSE и MAE
  - Практические рекомендации по выбору модели

## Литература

1. [Medical image denoising using convolutional denoising autoencoders](https://arxiv.org/abs/1608.04667)
2. [Deep Learning on Image Denoising: An Overview](https://arxiv.org/abs/1912.13171)
3. [Denoising Vanilla Autoencoder for RGB and GS Images with Gaussian Noise](https://www.researchgate.net/publication/331577872)
4. [BCCD Dataset](https://github.com/Shenggan/BCCD_Dataset)

## Автор

Лабораторная работа по курсу "Deep Learning"

## Лицензия

Данный проект создан в образовательных целях.
